#!/bin/bash
#
# guardrails - CLI management tool for claude-guardrails
# Defense-in-depth safety hooks for Claude Code
#

set -e

# =============================================================================
# Configuration
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PACKAGE_DIR="$(dirname "$SCRIPT_DIR")"
CLAUDE_DIR="$HOME/.claude"
SETTINGS_FILE="$CLAUDE_DIR/settings.json"
OVERRIDES_FILE="$CLAUDE_DIR/guardrails-overrides.json"
LOGS_DIR="$CLAUDE_DIR/guardrails-logs"
HOOKS_DIR="$PACKAGE_DIR/src/hooks"

# =============================================================================
# Colors
# =============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# =============================================================================
# Helper Functions
# =============================================================================

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

print_info() {
    echo -e "${BLUE}→${NC} $1"
}

print_header() {
    echo -e "\n${BOLD}${CYAN}$1${NC}"
    echo -e "${DIM}$(printf '%.0s─' {1..50})${NC}"
}

ensure_claude_dir() {
    if [[ ! -d "$CLAUDE_DIR" ]]; then
        mkdir -p "$CLAUDE_DIR"
    fi
}

ensure_settings_file() {
    ensure_claude_dir
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        echo '{}' > "$SETTINGS_FILE"
    fi
}

ensure_overrides_file() {
    ensure_claude_dir
    if [[ ! -f "$OVERRIDES_FILE" ]]; then
        cat > "$OVERRIDES_FILE" << 'EOF'
{
  "allowed_paths": [],
  "allowed_commands": [],
  "allowed_branches": []
}
EOF
    fi
}

has_jq() {
    command -v jq &> /dev/null
}

# =============================================================================
# Command: status
# =============================================================================

cmd_status() {
    print_header "Guardrails Status"

    # Check if settings.json exists
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        print_warning "Settings file not found: $SETTINGS_FILE"
        echo -e "  Run ${CYAN}guardrails activate${NC} to set up hooks"
        return 0
    fi

    # Check for PreToolUse hooks
    local hooks_active=false
    local hook_count=0

    if has_jq; then
        if jq -e '.hooks.PreToolUse' "$SETTINGS_FILE" &> /dev/null; then
            hooks_active=true
            hook_count=$(jq '.hooks.PreToolUse | length' "$SETTINGS_FILE" 2>/dev/null || echo 0)
        fi
    else
        if grep -q '"PreToolUse"' "$SETTINGS_FILE" 2>/dev/null; then
            hooks_active=true
            hook_count="unknown (install jq for details)"
        fi
    fi

    # Display status
    echo
    if [[ "$hooks_active" == "true" ]]; then
        print_success "Hooks are ${GREEN}ACTIVE${NC}"
        echo -e "  Configured hooks: ${CYAN}$hook_count${NC}"
    else
        print_warning "Hooks are ${YELLOW}INACTIVE${NC}"
        echo -e "  Run ${CYAN}guardrails activate${NC} to enable"
    fi

    # List configured hooks if jq available
    if [[ "$hooks_active" == "true" ]] && has_jq; then
        echo
        echo -e "${BOLD}Configured Hooks:${NC}"
        jq -r '.hooks.PreToolUse[]? | "  • \(.hookPath // .command // "unknown")"' "$SETTINGS_FILE" 2>/dev/null || true
    fi

    # Show key paths
    print_header "Paths"
    echo -e "  Settings:   ${DIM}$SETTINGS_FILE${NC}"
    echo -e "  Overrides:  ${DIM}$OVERRIDES_FILE${NC}"
    echo -e "  Logs:       ${DIM}$LOGS_DIR/${NC}"
    echo -e "  Hooks:      ${DIM}$HOOKS_DIR/${NC}"
    echo -e "  Package:    ${DIM}$PACKAGE_DIR/${NC}"

    # Check if overrides exist
    if [[ -f "$OVERRIDES_FILE" ]] && has_jq; then
        local override_count=$(jq '[.allowed_paths, .allowed_commands, .allowed_branches] | map(length) | add' "$OVERRIDES_FILE" 2>/dev/null || echo 0)
        if [[ "$override_count" -gt 0 ]]; then
            echo
            print_info "Active overrides: $override_count"
            echo -e "  Run ${CYAN}guardrails override list${NC} for details"
        fi
    fi

    echo
}

# =============================================================================
# Command: activate
# =============================================================================

cmd_activate() {
    print_header "Activating Guardrails"

    ensure_settings_file

    # Define the hooks configuration
    local hooks_config
    hooks_config=$(cat << EOF
{
  "PreToolUse": [
    {
      "hookPath": "$HOOKS_DIR/path-guardian.sh",
      "timeout": 5000
    },
    {
      "hookPath": "$HOOKS_DIR/git-guardian.sh",
      "timeout": 5000
    },
    {
      "hookPath": "$HOOKS_DIR/audit-logger.sh",
      "timeout": 2000
    }
  ]
}
EOF
)

    if has_jq; then
        # Merge hooks into existing settings
        local temp_file=$(mktemp)
        jq --argjson hooks "$hooks_config" '.hooks = $hooks' "$SETTINGS_FILE" > "$temp_file"
        mv "$temp_file" "$SETTINGS_FILE"
        print_success "Hooks configuration added to settings.json"
    else
        # Without jq, we need to be more careful
        if grep -q '"hooks"' "$SETTINGS_FILE" 2>/dev/null; then
            print_error "Cannot update existing hooks section without jq"
            print_info "Install jq: brew install jq (macOS) or apt install jq (Linux)"
            return 1
        fi

        # Simple append for empty or minimal settings
        if [[ "$(cat "$SETTINGS_FILE")" == "{}" ]]; then
            cat > "$SETTINGS_FILE" << EOF
{
  "hooks": $hooks_config
}
EOF
            print_success "Hooks configuration added to settings.json"
        else
            print_error "Cannot safely modify settings.json without jq"
            print_info "Install jq: brew install jq (macOS) or apt install jq (Linux)"
            return 1
        fi
    fi

    # Ensure hooks are executable
    if [[ -d "$HOOKS_DIR" ]]; then
        chmod +x "$HOOKS_DIR"/*.sh 2>/dev/null || true
    fi

    # Create logs directory
    mkdir -p "$LOGS_DIR"

    # Initialize overrides file
    ensure_overrides_file

    echo
    print_warning "IMPORTANT: Restart Claude Code for changes to take effect"
    echo -e "  Close and reopen your terminal, or restart the Claude Code process"
    echo
    print_success "Guardrails activated!"
    echo
}

# =============================================================================
# Command: deactivate
# =============================================================================

cmd_deactivate() {
    print_header "Deactivating Guardrails"

    if [[ ! -f "$SETTINGS_FILE" ]]; then
        print_warning "Settings file not found - nothing to deactivate"
        return 0
    fi

    if has_jq; then
        # Check if hooks exist
        if ! jq -e '.hooks' "$SETTINGS_FILE" &> /dev/null; then
            print_info "No hooks configured - already inactive"
            return 0
        fi

        # Remove hooks section
        local temp_file=$(mktemp)
        jq 'del(.hooks)' "$SETTINGS_FILE" > "$temp_file"
        mv "$temp_file" "$SETTINGS_FILE"
        print_success "Hooks removed from settings.json"
    else
        if ! grep -q '"hooks"' "$SETTINGS_FILE" 2>/dev/null; then
            print_info "No hooks configured - already inactive"
            return 0
        fi

        print_error "Cannot safely modify settings.json without jq"
        print_info "Install jq: brew install jq (macOS) or apt install jq (Linux)"
        print_info "Or manually remove the 'hooks' section from: $SETTINGS_FILE"
        return 1
    fi

    echo
    print_info "Hook files preserved in: $HOOKS_DIR"
    print_info "Log files preserved in: $LOGS_DIR"
    print_info "Overrides preserved in: $OVERRIDES_FILE"
    echo
    print_warning "IMPORTANT: Restart Claude Code for changes to take effect"
    echo
    print_success "Guardrails deactivated!"
    echo
}

# =============================================================================
# Command: logs
# =============================================================================

cmd_logs() {
    local date_arg="${1:-$(date +%Y-%m-%d)}"
    local log_file="$LOGS_DIR/$date_arg.jsonl"

    # Validate date format
    if ! [[ "$date_arg" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
        print_error "Invalid date format. Use YYYY-MM-DD"
        echo -e "  Example: ${CYAN}guardrails logs 2024-01-15${NC}"
        return 1
    fi

    if [[ ! -f "$log_file" ]]; then
        print_warning "No logs found for $date_arg"
        echo -e "  Log file: ${DIM}$log_file${NC}"

        # List available log files
        if [[ -d "$LOGS_DIR" ]]; then
            local available=$(ls -1 "$LOGS_DIR"/*.jsonl 2>/dev/null | head -5)
            if [[ -n "$available" ]]; then
                echo
                print_info "Available log dates:"
                for f in $available; do
                    echo "  • $(basename "$f" .jsonl)"
                done
            fi
        fi
        return 0
    fi

    print_header "Guardrails Audit Log: $date_arg"
    echo -e "${DIM}$log_file${NC}"
    echo

    if has_jq; then
        # Pretty print with jq
        while IFS= read -r line; do
            echo "$line" | jq -r '
                "\(.timestamp | split("T")[1] | split(".")[0]) [\(.decision | if . == "allow" then "\u001b[32m\(.)\u001b[0m" elif . == "block" then "\u001b[31m\(.)\u001b[0m" else . end)] \(.tool_name) - \(.reason // "no reason")"
            ' 2>/dev/null || echo "$line"
        done < "$log_file"
    else
        # Plain output
        cat "$log_file"
    fi
}

# =============================================================================
# Command: test
# =============================================================================

cmd_test() {
    print_header "Running Guardrails Test Suite"

    local passed=0
    local failed=0
    local total=0

    run_test() {
        local name="$1"
        local expected="$2"
        local result="$3"

        ((total++))

        if [[ "$result" == "$expected" ]]; then
            print_success "$name"
            ((passed++))
        else
            print_error "$name (expected: $expected, got: $result)"
            ((failed++))
        fi
    }

    # Check if hooks exist
    if [[ ! -f "$HOOKS_DIR/path-guardian.sh" ]]; then
        print_error "Hook files not found in $HOOKS_DIR"
        print_info "Run the install script first"
        return 1
    fi

    echo
    echo -e "${BOLD}Path Guardian Tests${NC}"
    echo -e "${DIM}────────────────────${NC}"

    # Test 1: Allow file in current directory
    local test_input='{"tool_name":"Write","tool_input":{"file_path":"'$(pwd)'/test.txt"}}'
    local result=$("$HOOKS_DIR/path-guardian.sh" <<< "$test_input" 2>/dev/null | head -1 | tr -d '[:space:]')
    if [[ "$result" == '{"decision":"allow"}' ]] || [[ "$result" == *'"decision":"allow"'* ]]; then
        run_test "Allow file in CWD" "allow" "allow"
    else
        run_test "Allow file in CWD" "allow" "block"
    fi

    # Test 2: Block file outside CWD (root)
    test_input='{"tool_name":"Write","tool_input":{"file_path":"/etc/passwd"}}'
    result=$("$HOOKS_DIR/path-guardian.sh" <<< "$test_input" 2>/dev/null | head -1)
    if [[ "$result" == *'"decision":"block"'* ]]; then
        run_test "Block sensitive system path (/etc/passwd)" "block" "block"
    else
        run_test "Block sensitive system path (/etc/passwd)" "block" "allow"
    fi

    # Test 3: Block home directory sensitive files
    test_input='{"tool_name":"Read","tool_input":{"file_path":"'$HOME'/.ssh/id_rsa"}}'
    result=$("$HOOKS_DIR/path-guardian.sh" <<< "$test_input" 2>/dev/null | head -1)
    if [[ "$result" == *'"decision":"block"'* ]]; then
        run_test "Block sensitive path (~/.ssh/id_rsa)" "block" "block"
    else
        run_test "Block sensitive path (~/.ssh/id_rsa)" "block" "allow"
    fi

    echo
    echo -e "${BOLD}Git Guardian Tests${NC}"
    echo -e "${DIM}───────────────────${NC}"

    # Test 4: Allow feature branch push
    test_input='{"tool_name":"Bash","tool_input":{"command":"git push origin feature/test"}}'
    result=$("$HOOKS_DIR/git-guardian.sh" <<< "$test_input" 2>/dev/null | head -1)
    if [[ "$result" == *'"decision":"allow"'* ]]; then
        run_test "Allow push to feature branch" "allow" "allow"
    else
        run_test "Allow push to feature branch" "allow" "block"
    fi

    # Test 5: Block push to main
    test_input='{"tool_name":"Bash","tool_input":{"command":"git push origin main"}}'
    result=$("$HOOKS_DIR/git-guardian.sh" <<< "$test_input" 2>/dev/null | head -1)
    if [[ "$result" == *'"decision":"block"'* ]]; then
        run_test "Block push to main branch" "block" "block"
    else
        run_test "Block push to main branch" "block" "allow"
    fi

    # Test 6: Block force push
    test_input='{"tool_name":"Bash","tool_input":{"command":"git push --force origin feature"}}'
    result=$("$HOOKS_DIR/git-guardian.sh" <<< "$test_input" 2>/dev/null | head -1)
    if [[ "$result" == *'"decision":"block"'* ]]; then
        run_test "Block force push" "block" "block"
    else
        run_test "Block force push" "block" "allow"
    fi

    # Test 7: Allow force-with-lease
    test_input='{"tool_name":"Bash","tool_input":{"command":"git push --force-with-lease origin feature"}}'
    result=$("$HOOKS_DIR/git-guardian.sh" <<< "$test_input" 2>/dev/null | head -1)
    if [[ "$result" == *'"decision":"allow"'* ]]; then
        run_test "Allow force-with-lease" "allow" "allow"
    else
        run_test "Allow force-with-lease" "allow" "block"
    fi

    echo
    echo -e "${BOLD}Audit Logger Tests${NC}"
    echo -e "${DIM}───────────────────${NC}"

    # Test 8: Verify log entry created
    local today=$(date +%Y-%m-%d)
    local log_file="$LOGS_DIR/$today.jsonl"
    local log_count_before=0
    if [[ -f "$log_file" ]]; then
        log_count_before=$(wc -l < "$log_file")
    fi

    test_input='{"tool_name":"TestTool","tool_input":{"test":"value"}}'
    "$HOOKS_DIR/audit-logger.sh" <<< "$test_input" &>/dev/null || true

    if [[ -f "$log_file" ]]; then
        local log_count_after=$(wc -l < "$log_file")
        if [[ "$log_count_after" -gt "$log_count_before" ]]; then
            run_test "Log entry created" "created" "created"
        else
            run_test "Log entry created" "created" "not created"
        fi
    else
        run_test "Log entry created" "created" "not created"
    fi

    # Summary
    print_header "Test Results"
    echo -e "  Passed: ${GREEN}$passed${NC}"
    echo -e "  Failed: ${RED}$failed${NC}"
    echo -e "  Total:  $total"
    echo

    if [[ "$failed" -gt 0 ]]; then
        print_error "Some tests failed"
        return 1
    else
        print_success "All tests passed!"
        return 0
    fi
}

# =============================================================================
# Command: override
# =============================================================================

cmd_override() {
    local subcommand="$1"
    shift || true

    case "$subcommand" in
        add)
            cmd_override_add "$@"
            ;;
        list)
            cmd_override_list
            ;;
        clear)
            cmd_override_clear
            ;;
        *)
            print_error "Unknown override subcommand: $subcommand"
            echo
            echo "Usage:"
            echo -e "  ${CYAN}guardrails override add <type> <value>${NC}"
            echo -e "  ${CYAN}guardrails override list${NC}"
            echo -e "  ${CYAN}guardrails override clear${NC}"
            echo
            echo "Types: path, command, branch"
            return 1
            ;;
    esac
}

cmd_override_add() {
    local type="$1"
    local value="$2"

    if [[ -z "$type" ]] || [[ -z "$value" ]]; then
        print_error "Missing arguments"
        echo -e "Usage: ${CYAN}guardrails override add <type> <value>${NC}"
        echo
        echo "Types:"
        echo "  path     - Allow access to a specific path"
        echo "  command  - Allow a specific command"
        echo "  branch   - Allow pushing to a specific branch"
        echo
        echo "Examples:"
        echo -e "  ${DIM}guardrails override add path /var/log/myapp${NC}"
        echo -e "  ${DIM}guardrails override add command \"rm -rf ./cache\"${NC}"
        echo -e "  ${DIM}guardrails override add branch develop${NC}"
        return 1
    fi

    # Map type to JSON key
    local key
    case "$type" in
        path)
            key="allowed_paths"
            ;;
        command)
            key="allowed_commands"
            ;;
        branch)
            key="allowed_branches"
            ;;
        *)
            print_error "Unknown override type: $type"
            echo "Valid types: path, command, branch"
            return 1
            ;;
    esac

    ensure_overrides_file

    if ! has_jq; then
        print_error "jq is required for override management"
        print_info "Install jq: brew install jq (macOS) or apt install jq (Linux)"
        return 1
    fi

    # Check if value already exists
    if jq -e --arg v "$value" --arg k "$key" '.[$k] | index($v)' "$OVERRIDES_FILE" &>/dev/null; then
        print_warning "Override already exists: $value"
        return 0
    fi

    # Add the override
    local temp_file=$(mktemp)
    jq --arg v "$value" --arg k "$key" '.[$k] += [$v]' "$OVERRIDES_FILE" > "$temp_file"
    mv "$temp_file" "$OVERRIDES_FILE"

    print_success "Added $type override: $value"
}

cmd_override_list() {
    print_header "Current Overrides"

    if [[ ! -f "$OVERRIDES_FILE" ]]; then
        print_info "No overrides configured"
        echo -e "  Add one with: ${CYAN}guardrails override add <type> <value>${NC}"
        return 0
    fi

    if ! has_jq; then
        cat "$OVERRIDES_FILE"
        return 0
    fi

    echo
    echo -e "${BOLD}Allowed Paths:${NC}"
    local paths=$(jq -r '.allowed_paths[]?' "$OVERRIDES_FILE" 2>/dev/null)
    if [[ -n "$paths" ]]; then
        echo "$paths" | while read -r p; do
            echo -e "  ${GREEN}•${NC} $p"
        done
    else
        echo -e "  ${DIM}(none)${NC}"
    fi

    echo
    echo -e "${BOLD}Allowed Commands:${NC}"
    local commands=$(jq -r '.allowed_commands[]?' "$OVERRIDES_FILE" 2>/dev/null)
    if [[ -n "$commands" ]]; then
        echo "$commands" | while read -r c; do
            echo -e "  ${GREEN}•${NC} $c"
        done
    else
        echo -e "  ${DIM}(none)${NC}"
    fi

    echo
    echo -e "${BOLD}Allowed Branches:${NC}"
    local branches=$(jq -r '.allowed_branches[]?' "$OVERRIDES_FILE" 2>/dev/null)
    if [[ -n "$branches" ]]; then
        echo "$branches" | while read -r b; do
            echo -e "  ${GREEN}•${NC} $b"
        done
    else
        echo -e "  ${DIM}(none)${NC}"
    fi

    echo
}

cmd_override_clear() {
    print_header "Clearing Overrides"

    if [[ ! -f "$OVERRIDES_FILE" ]]; then
        print_info "No overrides file exists"
        return 0
    fi

    # Reset to empty arrays
    cat > "$OVERRIDES_FILE" << 'EOF'
{
  "allowed_paths": [],
  "allowed_commands": [],
  "allowed_branches": []
}
EOF

    print_success "All overrides cleared"
}

# =============================================================================
# Command: update
# =============================================================================

cmd_update() {
    print_header "Updating Guardrails"

    # Check if we're in a git repo
    if [[ ! -d "$PACKAGE_DIR/.git" ]]; then
        print_error "Package directory is not a git repository"
        print_info "Package location: $PACKAGE_DIR"
        return 1
    fi

    echo -e "Package directory: ${DIM}$PACKAGE_DIR${NC}"
    echo

    # Pull latest
    print_info "Pulling latest changes..."
    cd "$PACKAGE_DIR"

    if git pull; then
        print_success "Repository updated"
    else
        print_error "Failed to pull updates"
        return 1
    fi

    echo

    # Re-run install if install script exists
    if [[ -f "$PACKAGE_DIR/scripts/install.sh" ]]; then
        print_info "Running install script..."
        if bash "$PACKAGE_DIR/scripts/install.sh"; then
            print_success "Installation complete"
        else
            print_warning "Install script returned non-zero exit code"
        fi
    else
        print_info "No install script found - skipping reinstall"
    fi

    echo
    print_success "Update complete!"
    print_warning "Restart Claude Code for changes to take effect"
    echo
}

# =============================================================================
# Command: help
# =============================================================================

cmd_help() {
    echo
    echo -e "${BOLD}${CYAN}guardrails${NC} - CLI management tool for claude-guardrails"
    echo -e "${DIM}Defense-in-depth safety hooks for Claude Code${NC}"
    echo
    echo -e "${BOLD}USAGE${NC}"
    echo "  guardrails <command> [options]"
    echo
    echo -e "${BOLD}COMMANDS${NC}"
    echo -e "  ${CYAN}status${NC}                        Show if hooks are active and list configured hooks"
    echo -e "  ${CYAN}activate${NC}                      Enable hooks in settings.json"
    echo -e "  ${CYAN}deactivate${NC}                    Disable hooks (keeps files, removes from config)"
    echo -e "  ${CYAN}logs${NC} [YYYY-MM-DD]             View audit logs (today by default)"
    echo -e "  ${CYAN}test${NC}                          Run test suite to verify all hooks work"
    echo
    echo -e "  ${CYAN}override add${NC} <type> <value>   Add an override (type: path, command, branch)"
    echo -e "  ${CYAN}override list${NC}                 Show current overrides"
    echo -e "  ${CYAN}override clear${NC}                Clear all overrides"
    echo
    echo -e "  ${CYAN}update${NC}                        Pull latest from repo and reinstall"
    echo -e "  ${CYAN}help${NC}                          Show this help message"
    echo
    echo -e "${BOLD}EXAMPLES${NC}"
    echo -e "  ${DIM}# Check current status${NC}"
    echo "  guardrails status"
    echo
    echo -e "  ${DIM}# View today's audit logs${NC}"
    echo "  guardrails logs"
    echo
    echo -e "  ${DIM}# View logs for a specific date${NC}"
    echo "  guardrails logs 2024-01-15"
    echo
    echo -e "  ${DIM}# Allow access to a specific path${NC}"
    echo "  guardrails override add path /var/log/myapp"
    echo
    echo -e "  ${DIM}# Allow pushing to develop branch${NC}"
    echo "  guardrails override add branch develop"
    echo
    echo -e "${BOLD}FILES${NC}"
    echo -e "  ${DIM}~/.claude/settings.json${NC}           Claude Code settings (hooks config)"
    echo -e "  ${DIM}~/.claude/guardrails-overrides.json${NC}  Override rules"
    echo -e "  ${DIM}~/.claude/guardrails-logs/${NC}          Audit log directory"
    echo
}

# =============================================================================
# Main Entry Point
# =============================================================================

main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        status)
            cmd_status
            ;;
        activate)
            cmd_activate
            ;;
        deactivate)
            cmd_deactivate
            ;;
        logs)
            cmd_logs "$@"
            ;;
        test)
            cmd_test
            ;;
        override)
            cmd_override "$@"
            ;;
        update)
            cmd_update
            ;;
        help|--help|-h)
            cmd_help
            ;;
        version|--version|-v)
            echo "guardrails v1.0.0"
            ;;
        *)
            print_error "Unknown command: $command"
            echo -e "Run ${CYAN}guardrails help${NC} for usage information"
            exit 1
            ;;
    esac
}

main "$@"
